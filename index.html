<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>神神化化作戰部 - 聚會神器</title>
    
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-primary: #FF6B6B; 
            --color-secondary: #4ECDC4;
            --color-bg: #FFF5F5;
            --color-text: #2C3E50;
        }
        body { 
            font-family: 'Zen Maru Gothic', sans-serif; 
            background-color: var(--color-bg);
            color: var(--color-text);
            -webkit-tap-highlight-color: transparent;
        }
        .card-rounded { border-radius: 20px; }
        [v-cloak] { display: none !important; }
        
        .vote-bar { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="min-h-screen pb-24">

    <div id="app" class="max-w-md mx-auto relative p-4" v-cloak>
        
        <!-- Header -->
        <header class="mb-4 pt-2 sticky top-0 z-30 bg-[var(--color-bg)]/95 backdrop-blur-sm pb-2">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-2xl font-black text-slate-700 flex items-center">
                        <i class="fas fa-ghost text-[var(--color-primary)] mr-3"></i>神神化化作戰部
                    </h1>
                    <p class="text-xs text-slate-400 font-bold ml-1 flex items-center h-5">
                        <span v-if="loading" class="text-[var(--color-secondary)]"><i class="fas fa-sync fa-spin mr-1"></i>同步中...</span>
                        <span v-else-if="lastSaved" class="text-slate-300"><i class="fas fa-check mr-1"></i>已儲存</span>
                    </p>
                </div>
                <button @click="showPeopleModal = true" class="w-10 h-10 rounded-full bg-white shadow-sm border border-slate-100 text-slate-500 hover:text-[var(--color-primary)] transition flex items-center justify-center relative">
                    <i class="fas fa-users-cog"></i>
                    <span v-if="people.length === 0" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-ping"></span>
                </button>
            </div>

            <!-- Tabs -->
            <div class="flex p-1 bg-white rounded-2xl shadow-sm border border-slate-100">
                <button @click="currentTab = 'signup'" 
                    :class="['flex-1 py-2 rounded-xl text-sm font-bold transition-all duration-300', currentTab === 'signup' ? 'bg-slate-800 text-white shadow-md' : 'text-slate-400 hover:bg-slate-50']">
                    <i class="fas fa-calendar-check mr-2"></i>聚會投票
                </button>
                <button @click="currentTab = 'calculator'" 
                    :class="['flex-1 py-2 rounded-xl text-sm font-bold transition-all duration-300', currentTab === 'calculator' ? 'bg-[var(--color-primary)] text-white shadow-md' : 'text-slate-400 hover:bg-slate-50']">
                    <i class="fas fa-calculator mr-2"></i>計算機
                </button>
            </div>
        </header>

        <!-- ==================== TAB 1: 聚會投票 (Signup) ==================== -->
        <div v-show="currentTab === 'signup'">
            
            <button @click="openEventModal()" class="w-full bg-[var(--color-secondary)] hover:opacity-90 text-white font-bold py-4 rounded-2xl shadow-lg transition transform active:scale-95 flex items-center justify-center text-lg mb-6">
                <i class="fas fa-plus-circle mr-2"></i> 發起新聚會
            </button>

            <!-- 提示新增成員 -->
            <div v-if="people.length === 0" class="bg-amber-50 border border-amber-200 rounded-2xl p-4 mb-6 text-center">
                <p class="text-amber-600 font-bold mb-2 text-sm"><i class="fas fa-exclamation-triangle mr-1"></i>還沒有成員名單</p>
                <button @click="showPeopleModal = true" class="bg-amber-400 text-white px-4 py-2 rounded-xl font-bold text-sm shadow-sm hover:bg-amber-500 transition">
                    設定成員才能開始投票
                </button>
            </div>

            <div class="space-y-6">
                <div v-if="sortedEvents.length === 0" class="text-center py-12 text-slate-300">
                    <i class="fas fa-calendar-times text-5xl mb-3 opacity-30"></i>
                    <p class="text-sm font-bold">目前沒有聚會</p>
                </div>

                <div v-for="event in sortedEvents" :key="event.id" 
                     :class="['bg-white p-5 card-rounded shadow-sm border relative transition-all', 
                        isEventPast(event) ? 'border-slate-100 opacity-60 grayscale-[0.8] order-last' : 'border-slate-200 border-l-4',
                        (!isEventPast(event) && event.status === 'confirmed') ? 'border-l-[var(--color-secondary)]' : '',
                        (!isEventPast(event) && event.status === 'voting') ? 'border-l-amber-400' : '']">
                    
                    <!-- Event Header -->
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <div class="flex items-center flex-wrap gap-2 mb-1">
                                <span v-if="event.status === 'voting'" class="bg-amber-100 text-amber-600 text-[10px] px-2 py-0.5 rounded-full font-bold whitespace-nowrap">
                                    <i class="fas fa-vote-yea mr-1"></i>投票中
                                </span>
                                <span v-else class="bg-[var(--color-secondary)] text-white text-[10px] px-2 py-0.5 rounded-full font-bold whitespace-nowrap">
                                    <i class="fas fa-check mr-1"></i>成團
                                </span>
                                <span v-if="isEventPast(event)" class="bg-slate-200 text-slate-500 text-[10px] px-2 py-0.5 rounded-full font-bold whitespace-nowrap">
                                    <i class="fas fa-history mr-1"></i>已過期
                                </span>
                                <h3 class="text-xl font-black text-slate-800 break-all">{{ event.name }}</h3>
                            </div>
                            
                            <!-- Info Area -->
                            <div v-if="event.status === 'confirmed'" class="text-slate-500 font-bold mt-2 flex flex-col gap-1 text-sm">
                                <span class="flex items-center text-[var(--color-secondary)] text-lg">
                                    <i class="far fa-calendar-alt mr-2"></i>{{ formatDate(event.finalDate) }} 
                                    <span class="ml-2 text-xs bg-slate-100 px-2 rounded text-slate-400 align-middle">{{ getDayOfWeek(event.finalDate) }}</span>
                                </span>
                                <div class="flex flex-wrap gap-3 text-xs text-slate-400 mt-1">
                                    <span><i class="far fa-clock mr-1"></i>{{ event.startTime }} 開始</span>
                                    <span v-if="event.gatheringTime"><i class="fas fa-map-marker-alt mr-1"></i>{{ event.gatheringTime }} 集合</span>
                                </div>
                            </div>
                            <div v-else class="text-xs text-slate-400 font-bold mt-1">
                                <i class="fas fa-info-circle mr-1"></i>請在下方選擇你可以的日子
                            </div>
                        </div>
                        
                        <!-- Admin Actions -->
                        <div class="flex flex-col gap-2 ml-2">
                            <button @click="openEventModal(event)" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:bg-sky-50 hover:text-sky-500 transition flex items-center justify-center">
                                <i class="fas fa-pen text-xs"></i>
                            </button>
                            <button @click="deleteEvent(event.id)" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:bg-red-50 hover:text-red-500 transition flex items-center justify-center">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    </div>

                    <!-- VOTING AREA -->
                    <div v-if="event.status === 'voting'" class="mt-4 space-y-3">
                        <div v-if="people.length === 0" class="text-center py-4 bg-slate-50 rounded-xl border border-dashed border-slate-300">
                            <p class="text-xs text-slate-400 mb-2 font-bold">沒有成員，無法投票</p>
                            <button @click="showPeopleModal = true" class="text-xs bg-slate-200 hover:bg-slate-300 text-slate-600 px-3 py-1.5 rounded-lg font-bold transition">
                                <i class="fas fa-plus mr-1"></i>加入成員
                            </button>
                        </div>

                        <div v-else v-for="(dateOption, idx) in event.proposedDates" :key="idx" class="bg-slate-50 rounded-xl p-3 border border-slate-100">
                            <div class="flex justify-between items-center mb-2">
                                <div class="font-bold text-slate-700 flex items-center">
                                    <span class="text-lg mr-2 font-mono">{{ formatDateShort(dateOption.date) }}</span>
                                    <span class="text-[10px] text-slate-400 bg-white px-1.5 py-0.5 rounded border border-slate-100">{{ getDayOfWeek(dateOption.date) }}</span>
                                </div>
                                <button v-if="!isEventPast(event)" @click="finalizeDate(event, idx)" class="px-3 py-1 bg-slate-800 text-white text-[10px] rounded-lg hover:bg-black transition font-bold shadow-sm">
                                    成團
                                </button>
                            </div>
                            
                            <div class="flex flex-wrap gap-1.5 mb-2">
                                <button v-for="person in people" :key="person" 
                                    @click="!isEventPast(event) && toggleVote(event, idx, person)"
                                    :class="['px-2 py-1 rounded-md text-xs font-bold transition-all border select-none',
                                    hasVoted(dateOption, person) 
                                        ? 'bg-amber-400 text-white border-amber-400 shadow-sm' 
                                        : 'bg-white text-slate-300 border-slate-100 hover:border-slate-300',
                                    isEventPast(event) ? 'cursor-default opacity-80' : '']">
                                    {{ person }}
                                </button>
                            </div>
                            <div class="h-1.5 w-full bg-slate-200 rounded-full overflow-hidden">
                                <div class="h-full bg-amber-400 vote-bar" :style="{width: (getVotePercentage(dateOption)) + '%'}"></div>
                            </div>
                        </div>
                    </div>

                    <!-- CONFIRMED AREA (已成團區域) -->
                    <div v-else class="border-t border-slate-100 pt-4 mt-2">
                        <div class="flex justify-between items-end mb-3">
                            <p class="text-xs font-black text-slate-300 tracking-widest uppercase">出席名單</p>
                            <span class="text-2xl font-black text-[var(--color-secondary)]">{{ event.attendees.length }}<span class="text-sm text-slate-300 ml-1">人</span></span>
                        </div>
                        
                        <div class="flex flex-wrap gap-2 mb-4">
                            <span v-for="person in event.attendees" :key="person" 
                                class="group px-3 py-1.5 rounded-lg text-sm font-bold bg-[var(--color-secondary)] text-white shadow-sm flex items-center pr-2">
                                <i class="fas fa-check mr-1.5 text-xs opacity-70"></i>
                                {{ person }}
                                <button v-if="!isEventPast(event)" @click="removeAttendee(event, person)" class="ml-2 text-white/50 hover:text-white hover:bg-white/20 rounded-full w-5 h-5 flex items-center justify-center transition">
                                    <i class="fas fa-times text-[10px]"></i>
                                </button>
                            </span>
                            <span v-if="event.attendees.length === 0" class="text-xs text-slate-300 font-bold py-1">還沒有人</span>
                        </div>

                        <!-- Add Chopsticks Button -->
                        <div class="relative" v-if="!isEventPast(event)">
                            <button @click="toggleAddChopsticks(event)" class="w-full py-2 border-2 border-dashed border-slate-200 text-slate-400 rounded-xl font-bold text-sm hover:border-[var(--color-secondary)] hover:text-[var(--color-secondary)] transition flex items-center justify-center">
                                <i class="fas fa-utensils mr-2"></i>加雙筷 (補人)
                            </button>
                            
                            <!-- Dropdown -->
                            <div v-if="event.showAddChopsticks" class="mt-2 bg-slate-50 rounded-xl border border-slate-100 p-3 animate-slide-up">
                                <p class="text-xs font-bold text-slate-400 mb-2 ml-1">點擊加入還沒在名單的人：</p>
                                <div v-if="getNonAttendees(event).length > 0" class="flex flex-wrap gap-2">
                                    <button v-for="person in getNonAttendees(event)" :key="person" 
                                        @click="addChopsticks(event, person)"
                                        class="px-2 py-1 bg-white border border-slate-200 text-slate-600 rounded text-xs font-bold hover:bg-[var(--color-secondary)] hover:text-white hover:border-[var(--color-secondary)] transition">
                                        {{ person }}
                                    </button>
                                </div>
                                <div v-else class="text-center py-2">
                                    <span v-if="people.length === 0" class="text-xs text-red-400 font-bold">請先建立成員名單！</span>
                                    <span v-else class="text-xs text-slate-300 italic">全員到齊！</span>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- ==================== TAB 2: 計算機 (Calculator) ==================== -->
        <div v-show="currentTab === 'calculator'">
            
            <!-- 總洗費卡片 -->
            <div class="bg-gradient-to-br from-slate-500 to-slate-800 p-6 card-rounded shadow-xl mb-6 text-center text-white relative overflow-hidden">
                <p class="text-slate-300 text-xs mb-1 font-bold tracking-widest uppercase">總洗費</p>
                <h2 class="text-5xl font-black mb-4 tracking-tight font-mono">
                    <span class="text-2xl align-top mr-1">$</span>{{ totalExpense.toLocaleString() }}
                </h2>
                
                <!-- 這裡如果沒有成員，會顯示提示 -->
                <div v-if="people.length > 0" class="flex justify-center gap-2 flex-wrap pt-4 border-t border-slate-600">
                    <div v-for="name in people" :key="name" class="flex flex-col items-center min-w-[60px]">
                        <span class="font-bold mb-1 opacity-60 text-[10px]">{{ name }}</span>
                        <span class="bg-white/10 px-2 py-1 rounded-lg text-xs font-bold tracking-wide">
                            ${{ getPersonTotal(name).toLocaleString() }}
                        </span>
                    </div>
                </div>
                <div v-else class="pt-4 border-t border-slate-600 text-slate-400 text-xs font-bold">
                    <i class="fas fa-users mr-1"></i>請先設定成員
                </div>
            </div>

            <div class="flex gap-3 mb-6">
                <button @click="openExpenseModal" class="flex-1 bg-[var(--color-primary)] hover:opacity-90 text-white font-bold py-4 rounded-2xl shadow-lg transition transform active:scale-95 flex items-center justify-center text-lg">
                    <i class="fas fa-plus mr-2"></i> 記一筆
                </button>
                <button @click="openSettlement" class="w-20 bg-white text-slate-600 hover:bg-slate-50 font-bold rounded-2xl shadow-sm transition flex items-center justify-center flex-col text-xs border border-slate-100">
                    <i class="fas fa-calculator text-xl mb-1 text-emerald-500"></i> 結算
                </button>
            </div>

            <div v-if="expenses.length === 0" class="text-center py-12 text-slate-300">
                <i class="fas fa-receipt text-4xl mb-3 opacity-30"></i>
                <p class="text-sm font-bold">沒有消費紀錄</p>
            </div>

            <div class="space-y-3 pb-10">
                <div v-for="(exp, index) in expenses" :key="index" class="bg-white p-4 card-rounded shadow-sm flex justify-between items-center border border-slate-50 relative group">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center mr-4 font-black text-sm shrink-0 border border-slate-200">
                            {{ exp.payer ? String(exp.payer).charAt(0) : '?' }}
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-700 text-base line-clamp-1">{{ exp.description }}</h4>
                            <p class="text-xs font-bold mt-0.5 text-slate-400">
                                {{ exp.payer }} 先付
                            </p>
                        </div>
                    </div>
                    
                    <div class="text-right shrink-0 ml-3 flex flex-col items-end">
                        <span class="block font-black text-lg text-[var(--color-primary)]">
                            ${{ parseInt(exp.amount).toLocaleString() }}
                        </span>
                        <div class="flex gap-2 mt-1">
                            <button @click="openExpenseEditModal(exp)" class="text-xs text-sky-400 hover:text-sky-600 px-2 py-1 bg-sky-50 rounded transition font-bold">
                                <i class="fas fa-pen"></i>
                            </button>
                            <button @click="deleteExpense(exp)" :disabled="isDeleting === exp.id" class="text-xs text-red-400 hover:text-red-600 px-2 py-1 bg-red-50 rounded transition font-bold">
                                <span v-if="isDeleting === exp.id"><i class="fas fa-spinner fa-spin"></i></span>
                                <span v-else><i class="fas fa-trash"></i></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== Modals ==================== -->

        <!-- Event Modal (Create/Edit) -->
        <div v-if="showEventModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm" @click.self="showEventModal = false">
            <div class="bg-white card-rounded w-full max-w-sm p-6 shadow-2xl transform transition-all animate-slide-up max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold mb-6 text-slate-800 flex items-center">
                    <i :class="['fas mr-3', isEditingEvent ? 'fa-edit text-sky-500' : 'fa-calendar-plus text-[var(--color-secondary)]']"></i>
                    {{ isEditingEvent ? '修改活動' : '發起投票' }}
                </h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-400 mb-1 ml-1">活動名稱</label>
                        <input type="text" v-model="newEventData.name" class="w-full bg-slate-50 border-none rounded-2xl p-3 text-lg text-slate-800 font-bold focus:ring-2 focus:ring-[var(--color-secondary)] transition" placeholder="例如: 聖誕大餐">
                    </div>

                    <!-- Date Selection Section -->
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                        <label class="block text-xs font-black text-slate-400 mb-2 ml-1">候選日期 (可選多個)</label>
                        <div class="flex gap-2 mb-2">
                            <input type="date" v-model="tempDateInput" class="flex-1 bg-white border border-slate-200 rounded-xl p-2 text-sm font-bold text-slate-600">
                            <button @click="addProposedDate" class="bg-slate-200 hover:bg-slate-300 text-slate-600 px-3 rounded-xl"><i class="fas fa-plus"></i></button>
                        </div>
                        <div class="flex flex-wrap gap-2 mt-2">
                            <div v-for="(pd, idx) in newEventData.proposedDates" :key="idx" class="bg-white border border-slate-200 px-3 py-1.5 rounded-lg text-sm font-bold text-slate-600 flex items-center shadow-sm">
                                {{ formatDateShort(pd.date) }}
                                <button @click="removeProposedDate(idx)" class="ml-2 text-red-300 hover:text-red-500"><i class="fas fa-times-circle"></i></button>
                            </div>
                            <span v-if="!newEventData.proposedDates || newEventData.proposedDates.length === 0" class="text-xs text-slate-400 italic p-1">還未加入日期...</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-black text-slate-400 mb-1 ml-1">開始時間</label>
                            <input type="time" v-model="newEventData.startTime" class="w-full bg-slate-50 border-none rounded-2xl p-3 text-sm text-slate-800 font-bold focus:ring-2 focus:ring-[var(--color-secondary)]">
                        </div>
                        <div>
                            <label class="block text-xs font-black text-slate-400 mb-1 ml-1">集合時間 (選填)</label>
                            <input type="time" v-model="newEventData.gatheringTime" class="w-full bg-slate-50 border-none rounded-2xl p-3 text-sm text-slate-800 font-bold focus:ring-2 focus:ring-[var(--color-secondary)]">
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex space-x-3">
                    <button @click="showEventModal = false" class="flex-1 py-3 bg-slate-100 text-slate-500 rounded-2xl font-bold hover:bg-slate-200 transition">取消</button>
                    <button @click="submitEvent" :disabled="isSaving" class="flex-1 py-3 bg-[var(--color-secondary)] text-white rounded-2xl font-bold hover:opacity-90 transition shadow-lg flex justify-center items-center">
                        <span v-if="isSaving"><i class="fas fa-circle-notch fa-spin mr-2"></i>處理中</span>
                        <span v-else>確認</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Expense Modal -->
        <div v-if="showExpenseModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm" @click.self="showExpenseModal = false">
            <div class="bg-white card-rounded w-full max-w-sm p-6 shadow-2xl transform transition-all animate-slide-up">
                <h3 class="text-xl font-bold mb-6 text-slate-800 flex items-center">
                    <i class="fas fa-edit mr-3 text-[var(--color-primary)]"></i>
                    {{ isEditingExpense ? '修改消費紀錄' : '記一筆' }}
                </h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-400 mb-2 ml-1">金額</label>
                        <input type="number" v-model="newExpense.amount" class="w-full bg-slate-50 border-none rounded-2xl p-4 text-2xl text-slate-800 font-bold focus:ring-2 focus:ring-[var(--color-primary)] transition font-mono" placeholder="0" inputmode="numeric">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-400 mb-2 ml-1">項目</label>
                        <input type="text" v-model="newExpense.description" class="w-full bg-slate-50 border-none rounded-2xl p-4 text-base text-slate-800 font-bold focus:ring-2 focus:ring-[var(--color-primary)] transition" placeholder="例如: 晚餐、KTV">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-400 mb-2 ml-1">誰先付的？</label>
                        <div class="relative">
                            <select v-model="newExpense.payer" class="w-full bg-slate-50 border-none rounded-2xl p-4 text-base text-slate-800 font-bold focus:ring-2 focus:ring-[var(--color-primary)] appearance-none">
                                <option v-for="person in people" :key="person" :value="person">{{ person }}</option>
                            </select>
                            <i class="fas fa-chevron-down absolute right-5 top-5 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex space-x-3">
                    <button @click="showExpenseModal = false" class="flex-1 py-3 bg-slate-100 text-slate-500 rounded-2xl font-bold hover:bg-slate-200 transition">取消</button>
                    <button @click="submitExpense" :disabled="isSaving" class="flex-1 py-3 bg-[var(--color-primary)] text-white rounded-2xl font-bold hover:opacity-90 transition shadow-lg flex justify-center items-center">
                        <span v-if="isSaving"><i class="fas fa-circle-notch fa-spin mr-2"></i>處理中</span>
                        <span v-else>{{ isEditingExpense ? '更新' : '儲存' }}</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- People Manager Modal -->
        <div v-if="showPeopleModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm" @click.self="showPeopleModal = false">
            <div class="bg-white card-rounded w-full max-w-sm p-6 shadow-2xl">
                <h3 class="text-xl font-bold mb-4 text-slate-800">成員管理</h3>
                <p class="text-xs text-slate-400 mb-4">輸入名字後按 + 新增</p>
                
                <div class="flex gap-2 mb-4">
                    <input type="text" v-model="newPersonName" @keyup.enter="addPerson" placeholder="輸入名字..." class="flex-1 bg-slate-50 rounded-xl px-4 py-3 font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-400">
                    <button @click="addPerson" class="bg-slate-200 text-slate-600 px-4 rounded-xl font-bold hover:bg-slate-300 transition"><i class="fas fa-plus"></i></button>
                </div>

                <div class="space-y-2 mb-6 max-h-[300px] overflow-y-auto">
                    <div v-for="(person, idx) in people" :key="person" class="flex justify-between items-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                        <span class="font-bold text-slate-700">{{ person }}</span>
                        <button @click="removePerson(idx)" class="text-red-400 hover:text-red-600 w-8 h-8 flex items-center justify-center bg-white rounded-full shadow-sm"><i class="fas fa-times"></i></button>
                    </div>
                    <div v-if="people.length === 0" class="text-center py-4 text-slate-400 text-sm font-bold">
                        還沒有成員
                    </div>
                </div>

                <button @click="savePeople" :disabled="isSavingPeople" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold hover:opacity-90 transition flex justify-center items-center">
                    <span v-if="isSavingPeople"><i class="fas fa-circle-notch fa-spin mr-2"></i>同步中</span>
                    <span v-else>完成並同步</span>
                </button>
            </div>
        </div>

        <!-- Settlement Modal (Enhanced with Participant Selection) -->
        <div v-if="showSettlementModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm" @click.self="showSettlementModal = false">
            <div class="bg-white card-rounded w-full max-w-sm p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
                <h3 class="text-xl font-bold mb-4 text-slate-800 flex items-center"><i class="fas fa-calculator mr-3 text-emerald-500"></i>結算建議</h3>
                
                <!-- Participant Selector -->
                <div class="mb-5 bg-slate-50 rounded-xl p-3 border border-slate-100">
                    <p class="text-xs font-black text-slate-400 mb-2">
                        誰有份食？ ({{ selectedSettlementPeople.length }}/{{ people.length }})
                    </p>
                    <div class="flex flex-wrap gap-2">
                        <button v-for="person in people" :key="person" 
                            @click="toggleSettlementPerson(person)"
                            :class="['px-2 py-1 rounded-lg text-xs font-bold transition border', 
                                selectedSettlementPeople.includes(person) 
                                ? 'bg-slate-700 text-white border-slate-700' 
                                : 'bg-white text-slate-300 border-slate-200']">
                            {{ person }}
                        </button>
                    </div>
                </div>

                <div class="bg-emerald-50 rounded-xl p-4 mb-4 border border-emerald-100 text-center">
                    <div class="text-xs text-emerald-600 font-bold mb-1">每人應付 (除以 {{ selectedSettlementPeople.length }} 人)</div>
                    <div class="text-4xl font-black text-emerald-600">${{ Math.ceil(settlementResult.average).toLocaleString() }}</div>
                </div>

                <div v-if="settlementResult.plan.length > 0" class="space-y-3">
                    <div v-for="(plan, idx) in settlementResult.plan" :key="idx" class="flex items-center justify-between bg-white border border-slate-100 p-4 rounded-xl shadow-sm">
                        <div class="flex items-center">
                            <span class="font-bold text-slate-700">{{ plan.from }}</span>
                            <i class="fas fa-long-arrow-alt-right mx-3 text-slate-300"></i>
                            <span class="font-bold text-[var(--color-primary)]">{{ plan.to }}</span>
                        </div>
                        <span class="font-mono font-bold text-slate-700">${{ plan.amount.toLocaleString() }}</span>
                    </div>
                </div>
                <div v-else class="text-center py-8 text-slate-400 text-sm font-bold">
                    <span v-if="selectedSettlementPeople.length === 0">請至少選擇一人</span>
                    <span v-else>不用轉帳，大家收支平衡！</span>
                </div>

                <button @click="showSettlementModal = false" class="w-full mt-6 py-3 bg-slate-100 text-slate-500 rounded-xl font-bold hover:bg-slate-200 transition">關閉</button>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                // ============================================
                // 請確認這裡有你的 Google Apps Script 網址
                // ============================================
                const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbziElvEeQYCsdGpPMAMwAMXQvQXC2X0b_GT_qj8A_Z_yY7l0Zp_jBAt9urWwSVW_1t0/exec'; 
                const PASSWORD = '8964';

                // Core State
                const loading = ref(false);
                const lastSaved = ref(false);
                const currentTab = ref('signup');
                const people = ref([]);
                
                // Modal States
                const showPeopleModal = ref(false);
                const showEventModal = ref(false);
                const showExpenseModal = ref(false);
                const showSettlementModal = ref(false);

                // Data Models
                const events = ref([]);
                const expenses = ref([]);
                
                // Settlement State
                const selectedSettlementPeople = ref([]);
                
                // Form Inputs
                const newPersonName = ref('');
                const newEventData = ref({ name: '', status: 'voting', proposedDates: [], finalDate: '', gatheringTime: '', startTime: '', attendees: [] });
                const newExpense = ref({ amount: '', description: '', payer: '' });
                const tempDateInput = ref('');
                
                // Editing/Saving States
                const isEditingEvent = ref(false);
                const eventEditingId = ref(null);
                const isEditingExpense = ref(false);
                const expenseEditingId = ref(null);
                const isSaving = ref(false);
                const isDeleting = ref(null);
                const isSavingPeople = ref(false);

                // ==================== COMPUTED ====================
                
                const sortedEvents = computed(() => {
                    const today = new Date().toISOString().split('T')[0];
                    const voting = [];
                    const confirmedFuture = [];
                    const confirmedPast = [];
                    
                    events.value.forEach(e => {
                        if (!e.status) e.status = 'confirmed'; 
                        if (e.status === 'voting') {
                            voting.push(e);
                        } else {
                            if (e.finalDate < today) confirmedPast.push(e);
                            else confirmedFuture.push(e);
                        }
                    });

                    // 排序: 日期近的排前
                    const getFirstDate = (e) => e.proposedDates?.[0]?.date || '9999-99-99';
                    voting.sort((a, b) => new Date(getFirstDate(a)) - new Date(getFirstDate(b)));
                    
                    confirmedFuture.sort((a, b) => new Date(a.finalDate) - new Date(b.finalDate));
                    confirmedPast.sort((a, b) => new Date(b.finalDate) - new Date(a.finalDate));

                    return [...voting, ...confirmedFuture, ...confirmedPast];
                });

                const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + (parseInt(item.amount)||0), 0));
                
                // 這是給首頁顯示用的，還是除以總人數 (預設)
                const getPersonTotal = (name) => expenses.value.filter(e => e.payer === name).reduce((sum, e) => sum + (parseInt(e.amount)||0), 0);

                // 這是動態計算結算的邏輯
                const settlementResult = computed(() => {
                    const participants = selectedSettlementPeople.value;
                    if (participants.length === 0) return { average: 0, plan: [] };

                    // 1. 計算總金額
                    const total = expenses.value.reduce((sum, e) => sum + (parseInt(e.amount) || 0), 0);
                    const average = total / participants.length;

                    // 2. 初始化餘額
                    let balance = {};
                    // 先把每個人 (包含未參與但已付錢的人) 的餘額設為 0
                    people.value.forEach(p => balance[p] = 0);
                    
                    // 加上已付金額
                    expenses.value.forEach(e => {
                        if(balance[e.payer] === undefined) balance[e.payer] = 0;
                        balance[e.payer] += (parseInt(e.amount) || 0);
                    });

                    // 扣除應付金額 (只有參與者要扣)
                    participants.forEach(p => {
                        if(balance[p] !== undefined) balance[p] -= average;
                    });

                    // 3. 產生轉帳計畫
                    // 簡單的債務算法
                    // 找出付多的人 (Creditors) 和付少的人 (Debtors)
                    // 過濾掉沒參與且沒付錢的人 (balance 為 0)
                    const diffs = [];
                    for (const person in balance) {
                        // 處理浮點數誤差
                        if (Math.abs(balance[person]) > 0.01) {
                            diffs.push({ name: person, val: balance[person] });
                        }
                    }
                    diffs.sort((a, b) => a.val - b.val); // 負值在由小到大 (欠最多錢的在前面)

                    const plan = [];
                    let i = 0; 
                    let j = diffs.length - 1;

                    while (i < j) {
                        const debtor = diffs[i];
                        const creditor = diffs[j];

                        // 如果雙方餘額都趨近 0，結束
                        if (Math.abs(debtor.val) < 0.1 && Math.abs(creditor.val) < 0.1) break;

                        // 轉帳金額 = min(|欠款|, 債權)
                        const amount = Math.min(Math.abs(debtor.val), creditor.val);

                        if (amount > 0) {
                            plan.push({ 
                                from: debtor.name, 
                                to: creditor.name, 
                                amount: Math.ceil(amount) 
                            });
                        }

                        debtor.val += amount;
                        creditor.val -= amount;

                        if (Math.abs(debtor.val) < 0.1) i++;
                        if (Math.abs(creditor.val) < 0.1) j--;
                    }

                    return { average, plan };
                });


                // ==================== API HANDLER ====================

                const fetchData = async () => {
                    if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('請貼上')) return;
                    loading.value = true;
                    try {
                        const res = await fetch(`${APPS_SCRIPT_URL}?t=${Date.now()}`);
                        const data = await res.json();
                        
                        if (data.expenses && Array.isArray(data.expenses)) expenses.value = data.expenses;
                        if (data.people && Array.isArray(data.people)) people.value = data.people;
                        if (data.events && Array.isArray(data.events)) {
                            events.value = data.events.map(e => ({
                                ...e,
                                proposedDates: Array.isArray(e.proposedDates) ? e.proposedDates : [],
                                attendees: Array.isArray(e.attendees) ? e.attendees : []
                            }));
                        }
                    } catch (e) { console.error(e); } 
                    finally { loading.value = false; }
                };

                const saveToBackend = async (type, payload) => {
                    loading.value = true;
                    try {
                        await fetch(APPS_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify({ action: `update_${type}`, [type]: payload })
                        });
                        lastSaved.value = true;
                        setTimeout(() => lastSaved.value = false, 2000);
                    } catch (e) {
                        alert("儲存失敗，請檢查網路");
                    } finally {
                        loading.value = false;
                    }
                };

                const checkAuth = () => {
                    const pwd = prompt("請輸入密碼：");
                    return pwd === PASSWORD;
                };

                // ==================== PEOPLE LOGIC ====================

                const addPerson = () => {
                    const name = newPersonName.value.trim();
                    if(name && !people.value.includes(name)) { people.value.push(name); newPersonName.value = ''; }
                };
                
                const removePerson = (idx) => {
                    if(confirm(`移除「${people.value[idx]}」？`)) people.value.splice(idx, 1);
                };

                const savePeople = async () => {
                    isSavingPeople.value = true;
                    await saveToBackend('people', people.value);
                    isSavingPeople.value = false;
                    showPeopleModal.value = false;
                };

                // ==================== EVENTS LOGIC ====================

                const openEventModal = (event = null) => {
                    if (event && !checkAuth()) { alert("密碼錯誤"); return; }

                    tempDateInput.value = '';
                    if (event) {
                        isEditingEvent.value = true;
                        eventEditingId.value = event.id;
                        newEventData.value = JSON.parse(JSON.stringify(event));
                        if(!newEventData.value.proposedDates) newEventData.value.proposedDates = [];
                    } else {
                        isEditingEvent.value = false;
                        eventEditingId.value = null;
                        newEventData.value = { 
                            name: '', status: 'voting', proposedDates: [], 
                            finalDate: '', gatheringTime: '', startTime: '', attendees: [] 
                        };
                    }
                    showEventModal.value = true;
                };

                const addProposedDate = () => {
                    if (!tempDateInput.value) return;
                    if (newEventData.value.proposedDates.some(d => d.date === tempDateInput.value)) {
                        alert("日期已存在"); return;
                    }
                    newEventData.value.proposedDates.push({ date: tempDateInput.value, votes: [] });
                    newEventData.value.proposedDates.sort((a, b) => new Date(a.date) - new Date(b.date));
                    tempDateInput.value = '';
                };

                const removeProposedDate = (idx) => newEventData.value.proposedDates.splice(idx, 1);

                const submitEvent = async () => {
                    if (!newEventData.value.name || !newEventData.value.startTime) {
                        alert("請填寫活動名稱和開始時間"); return;
                    }
                    if (newEventData.value.proposedDates.length === 0 && !newEventData.value.finalDate) {
                        alert("請至少新增一個候選日期"); return;
                    }
                    
                    isSaving.value = true;
                    const id = isEditingEvent.value ? eventEditingId.value : 'evt-' + Date.now();
                    const payload = { ...newEventData.value, id };

                    if (isEditingEvent.value) {
                        const idx = events.value.findIndex(e => e.id === id);
                        if(idx !== -1) events.value[idx] = payload;
                    } else {
                        events.value.push(payload);
                    }

                    await saveToBackend('events', events.value);
                    showEventModal.value = false;
                    isSaving.value = false;
                };

                const deleteEvent = async (id) => {
                    if(!checkAuth()) { alert("密碼錯誤"); return; }
                    if(!confirm("確定刪除這個聚會？")) return;
                    events.value = events.value.filter(e => e.id !== id);
                    saveToBackend('events', events.value);
                };

                // Voting & Status Logic
                const toggleVote = (event, dateIdx, person) => {
                    const targetEvent = events.value.find(e => e.id === event.id);
                    if (!targetEvent) return;
                    
                    const votes = targetEvent.proposedDates[dateIdx].votes || [];
                    if (votes.includes(person)) {
                        targetEvent.proposedDates[dateIdx].votes = votes.filter(v => v !== person);
                    } else {
                        targetEvent.proposedDates[dateIdx].votes = [...votes, person];
                    }
                    saveToBackend('events', events.value);
                };

                const hasVoted = (dateOption, person) => dateOption.votes && dateOption.votes.includes(person);
                const getVotePercentage = (dateOption) => {
                    if(!people.value.length) return 0;
                    return ((dateOption.votes?.length || 0) / people.value.length) * 100;
                };

                const finalizeDate = async (event, dateIdx) => {
                    if(!checkAuth()) { alert("密碼錯誤"); return; }
                    const chosen = event.proposedDates[dateIdx];
                    if(!confirm(`確定成團嗎？日期：${chosen.date}\n出席者：${chosen.votes?.join(', ') || '無'}`)) return;

                    const target = events.value.find(e => e.id === event.id);
                    target.status = 'confirmed';
                    target.finalDate = chosen.date;
                    target.attendees = [...(chosen.votes || [])];
                    await saveToBackend('events', events.value);
                };

                const toggleAddChopsticks = (event) => {
                    event.showAddChopsticks = !event.showAddChopsticks;
                };

                const addChopsticks = async (event, person) => {
                    const target = events.value.find(e => e.id === event.id);
                    if(!target.attendees.includes(person)) {
                        target.attendees.push(person);
                        await saveToBackend('events', events.value);
                    }
                };

                const removeAttendee = async (event, person) => {
                    if(!confirm(`確定要將 ${person} 移出名單嗎？`)) return;

                    const target = events.value.find(e => e.id === event.id);
                    if(target) {
                        target.attendees = target.attendees.filter(p => p !== person);
                        await saveToBackend('events', events.value);
                    }
                };

                const getNonAttendees = (event) => people.value.filter(p => !event.attendees.includes(p));

                // ==================== EXPENSE LOGIC ====================

                const openExpenseModal = () => {
                    if(people.value.length === 0) { alert("請先設定成員！"); showPeopleModal.value = true; return; }
                    isEditingExpense.value = false;
                    expenseEditingId.value = null;
                    newExpense.value = { amount: '', description: '', payer: people.value[0] };
                    showExpenseModal.value = true;
                };

                const openExpenseEditModal = (item) => {
                    isEditingExpense.value = true;
                    expenseEditingId.value = item.id;
                    newExpense.value = { amount: parseInt(item.amount), description: item.description, payer: item.payer };
                    showExpenseModal.value = true;
                };

                const submitExpense = async () => {
                    if (!newExpense.value.amount || !newExpense.value.payer) return;
                    isSaving.value = true;
                    const action = isEditingExpense.value ? 'edit_expense' : 'add_expense';
                    const id = isEditingExpense.value ? expenseEditingId.value : 'id-' + Date.now();
                    const payload = { ...newExpense.value, action, id, amount: parseInt(newExpense.value.amount), description: newExpense.value.description || '未分類' };

                    try {
                        if (isEditingExpense.value) {
                            const idx = expenses.value.findIndex(e => e.id === id);
                            if (idx !== -1) expenses.value[idx] = { ...expenses.value[idx], ...payload };
                        } else {
                            expenses.value.unshift({ ...payload, date: new Date().toISOString() });
                        }
                        await fetch(APPS_SCRIPT_URL, {
                            method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify(payload)
                        });
                        showExpenseModal.value = false;
                        if (!isEditingExpense.value) setTimeout(fetchData, 1500);
                    } catch (e) { alert("失敗"); } finally { isSaving.value = false; }
                };

                const deleteExpense = async (item) => {
                    if(!confirm("確定刪除？")) return;
                    isDeleting.value = item.id;
                    try {
                        expenses.value = expenses.value.filter(e => e.id !== item.id);
                        await fetch(APPS_SCRIPT_URL, {
                            method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify({ action: 'delete_expense', id: item.id })
                        });
                    } catch(e) {} finally { isDeleting.value = null; }
                };

                // Settlement Logic
                const openSettlement = () => {
                    // 預設全選所有人
                    selectedSettlementPeople.value = [...people.value];
                    showSettlementModal.value = true;
                };

                const toggleSettlementPerson = (person) => {
                    if (selectedSettlementPeople.value.includes(person)) {
                        selectedSettlementPeople.value = selectedSettlementPeople.value.filter(p => p !== person);
                    } else {
                        selectedSettlementPeople.value.push(person);
                    }
                };

                // Utils
                const isEventPast = (e) => {
                    const today = new Date().toISOString().split('T')[0];
                    if(e.status === 'voting') return e.proposedDates?.every(d => d.date < today);
                    return e.finalDate < today;
                };
                const formatDate = (d) => d.replace(/-/g, '/');
                const formatDateShort = (d) => d.substring(5).replace('-', '/');
                const getDayOfWeek = (d) => '週' + ['日','一','二','三','四','五','六'][new Date(d).getDay()];
                

                onMounted(() => fetchData());

                return {
                    loading, lastSaved, currentTab, people, events, expenses,
                    showEventModal, showExpenseModal, showPeopleModal, showSettlementModal,
                    newPersonName, newEventData, newExpense, tempDateInput,
                    isEditingEvent, isEditingExpense, isSaving, isDeleting, isSavingPeople,
                    totalExpense, sortedEvents,
                    
                    // Settlement
                    selectedSettlementPeople, settlementResult, openSettlement, toggleSettlementPerson,
                    
                    fetchData, addPerson, removePerson, savePeople,
                    openEventModal, addProposedDate, removeProposedDate, submitEvent, deleteEvent,
                    toggleVote, hasVoted, getVotePercentage, finalizeDate, toggleAddChopsticks, addChopsticks, 
                    getNonAttendees, removeAttendee,
                    openExpenseModal, openExpenseEditModal, submitExpense, deleteExpense,
                    isEventPast, formatDate, formatDateShort, getDayOfWeek, getPersonTotal
                };
            }
        }).mount('#app');
    </script>
</body>
</html>